{% extends "utils.html" %}
{% load i18n %}
{% block title %}
    {% trans "Character Inventory" %}: {{ character_inventory.name }}
{% endblock title %}
{% block content %}
    <h2>{% trans "Currencies & Materials" %}</h2>
    <table class="mob ">
        <tr>
            <th>{% trans "Name" %}</th>
            <th>{% trans "Available" %}</th>
            <th>{% trans "Transfer" %}</th>
            <th>{% trans "Add" %}</th>
        </tr>
        {% for entry in pool_balances_list %}
        <tr>
            <td>{{ entry.type.name }}</td>
            <td>{{ entry.balance.amount }}</td>
            <td style="padding: 0.2em;">
                <form method="post" action="{% url 'orga_ci_transfer' run.event.slug run.number %}" style="display: flex; flex-direction: column; gap: 0.2em;">
                    {% csrf_token %}
                    <input type="hidden" name="source_inventory" value="{{ character_inventory.id }}">
                    <input type="hidden" name="pool_type" value="{{ entry.type.id }}">

                    <div style="display: flex; gap: 0.2em; align-items: center;">
                        <input type="number" name="amount" min="1" max="{{ entry.balance.amount }}" style="width: 3em; margin: 0; padding: 0.1em;">
                        <select name="target_inventory" style="width: auto; min-width: 4em; margin: 0; padding: 0.1em;">
                           <option value="">NPC</option>
                            {% for inv in all_inventories %}
                                {% if inv.id != character_inventory.id %}
                                    <option value="{{ inv.id }}">{{ inv.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="submit" style="margin: 0; padding: 0.2em 0.4em;">Transfer</button>
                    </div>

                    <input type="text" name="reason" placeholder="{% trans 'Reason' %}" style="margin: 0; padding: 0.1em; flex:1;">
                </form>
            </td>
            <td>
                {% if request.user.is_staff %}
                    <form method="post" action="{% url 'orga_ci_transfer' run.event.slug run.number %}">
                        {% csrf_token %}
                        <input type="hidden" name="source_inventory" value="">  {# NPC = None #}
                        <input type="hidden" name="target_inventory" value="{{ character_inventory.id }}">
                        <input type="hidden" name="pool_type" value="{{ entry.type.id }}">
                        <input type="number" name="amount" min="1" placeholder="Amount">
                        <input type="text" name="reason" placeholder="{% trans 'Reason' %}" style="flex:1; min-width:8em; margin:0; padding:0.1em;">
                        <button type="submit">{% trans "Add from NPC" %}</button>
                    </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    <h2>{% trans "Transfer Log" %}</h2>
    <table class="mob tight">
        <tr>
            <th>{% trans "Time" %}</th>
            <th>{% trans "Actor" %}</th>
            <th>{% trans "From" %}</th>
            <th>{% trans "To" %}</th>
            <th>{% trans "Resource" %}</th>
            <th>{% trans "Amount" %}</th>
            <th>{% trans "Reason" %}</th>
        </tr>
        {% for t in transfers %}
        <tr>
            <td>{{ t.timestamp|date:"Y-m-d H:i" }}</td>
            <td>{{ t.actor|default:"-" }}</td>
            <td>{{ t.source_inventory.name|default:"NPC" }}</td>
            <td>{{ t.target_inventory.name|default:"NPC" }}</td>
            <td>{{ t.pool_type.name }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.reason }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" style="text-align:center;">{% trans "No transfers yet." %}</td>
        </tr>
        {% endfor %}
    </table>
{% endblock content %}